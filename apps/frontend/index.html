<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í‘¸ë“œ ë Œì¦ˆ (ìµœì¢… v3)</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <h1>ğŸ“¸ AI í‘¸ë“œ ë Œì¦ˆ (Gemini + Imagen + Chat)</h1>
    
    <form id="upload-form">
        <p>ë¶„ì„í•˜ê³  ì‹¶ì€ ìŒì‹ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´, AIì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <input type="file" id="file-input" accept="image/*" required>
        <button type="submit">1. ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
    </form>
    
    <p id="loading">AIê°€ ì—´ì‹¬íˆ ë¶„ì„í•˜ê³ , ê·¸ë¦¼ë„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤... ğŸ¨</p>
    
    <div id="main-container">
        <div id="chat-wrapper">
            <h3>Gemini ëŒ€í™”ì°½:</h3>
            <div id="chat-log">
                <p>ì•„ì§ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="í›„ì† ì§ˆë¬¸í•˜ê¸° (ì˜ˆ: ì¹¼ë¡œë¦¬ ë‚®ì¶”ë ¤ë©´?)" required>
                <button type="submit">2. ì§ˆë¬¸ ì „ì†¡</button>
            </form>
        </div>
        
        <div id="image-wrapper">
            <h3>(ì›ë³¸ ì—…ë¡œë“œ ì´ë¯¸ì§€)</h3>
            <img id="preview" src="" alt="ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" style="display: none;" />

            <h3>Imagen ì¶”ì²œ ì´ë¯¸ì§€:</h3>
            <img id="imagen-generated-img" src="" alt="AIê°€ ìƒì„±í•œ ì¶”ì²œ ì‹ë‹¨ ì´ë¯¸ì§€" />
            <p id="imagen-text">ì•„ì§ ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        // JS ë³€ìˆ˜ ì„ ì–¸ë¶€
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const loadingEl = document.getElementById('loading');
        const chatLogEl = document.getElementById('chat-log');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const imagenImgEl = document.getElementById('imagen-generated-img');
        const imagenTextEl = document.getElementById('imagen-text');
        const previewEl = document.getElementById('preview');
        const ANALYZE_URL = 'http://127.0.0.1:5000/analyze'; 
        const CHAT_URL = 'http://127.0.0.1:5000/chat';
        let chatHistory = []; 
        let originalImageBase64 = null; 

        // 3. 'appendToChatLog' í•¨ìˆ˜
        function appendToChatLog(message, sender = 'ai') {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', sender);
            
            const senderTag = (sender === 'user') ? 'You:' : 'Food Lens:';
            
            let messageContent;
            if (sender === 'ai') {
                // AI ì‘ë‹µì€ Markdownìœ¼ë¡œ íŒŒì‹±
                messageContent = marked.parse(message);
            } else {
                // ì‚¬ìš©ì ì…ë ¥ì€ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œ
                messageContent = message.replace(/\n/g, '<br>');
            }
            
            messageEl.innerHTML = `<strong>${senderTag}</strong><br>${messageContent}`;
            chatLogEl.appendChild(messageEl);
            chatLogEl.scrollTop = chatLogEl.scrollHeight;
        }

        // fileToBase64 í•¨ìˆ˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }

        // updateImagen í•¨ìˆ˜
        function updateImagen(imageUrl) {
            if (imageUrl) {
                imagenImgEl.src = imageUrl;
                imagenImgEl.style.display = 'block';
                imagenTextEl.style.display = 'none';
            } else {
                imagenImgEl.style.display = 'none';
                imagenTextEl.innerHTML = "ì¶”ì²œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                imagenTextEl.style.display = 'block';
            }
        }
        
        // uploadForm ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const file = fileInput.files[0];
            if (!file) { alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            
            previewEl.src = URL.createObjectURL(file);
            previewEl.style.display = 'block';
            loadingEl.style.display = 'block';
            chatLogEl.innerHTML = "<p>ë¶„ì„ ì¤‘...</p>";
            imagenTextEl.innerHTML = "ìƒì„± ì¤‘...";
            imagenImgEl.style.display = 'none';
            chatHistory = [];

            try {
                originalImageBase64 = await fileToBase64(file);
            } catch (error) {
                chatLogEl.innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ì´ë¯¸ì§€ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ${error.message}</p>`;
                loadingEl.style.display = 'none';
                return;
            }

            const formData = new FormData();
            formData.append('image_file', file);

            try {
                const response = await fetch(ANALYZE_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                chatLogEl.innerHTML = ""; 
                appendToChatLog(data.analysis, 'ai');
                chatHistory.push({ role: 'ai', message: data.analysis });
                
                updateImagen(data.new_image_url);
                chatForm.style.display = 'flex';

            } catch (error) {
                console.error("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                chatLogEl.innerHTML = `<p style="color: red;">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        });

        // â¬‡ï¸ --- (ìˆ˜ì •) 'Show more'ê°€ ì œê±°ëœ chatForm ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ --- â¬‡ï¸
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;

            appendToChatLog(message, 'user');
            // 'Show more'ê°€ ì—¬ê¸°ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
            chatHistory.push({ role: 'user', message: message });
            chatInput.value = ""; 
            loadingEl.style.display = 'block';
            
            const history_text = chatHistory
                .map(entry => `${entry.role}: ${entry.message}`)
                .join('\n\n');

            try {
                const response = await fetch(CHAT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history_text: history_text,
                        image_base64: originalImageBase64
                    }), 
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                appendToChatLog(data.analysis, 'ai');
                chatHistory.push({ role: 'ai', message: data.analysis });
                
                updateImagen(data.new_image_url);

            } catch (error) {
                console.error("ì±„íŒ… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                appendToChatLog(`<p style="color: red;">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`, 'ai');
            } finally {
                loadingEl.style.display = 'none';
            }
        });
        // --- â¬†ï¸ (ìˆ˜ì •) â¬†ï¸ ---
    </script>
</body>
</html>
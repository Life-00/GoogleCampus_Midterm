<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í‘¸ë“œ ë Œì¦ˆ (ëŒ€í™”í˜• v2.1)</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2em auto; padding: 0 1em; }
        img { max-width: 100%; height: auto; margin-top: 1em; border: 1px solid #ddd; }
        #loading { display: none; color: #888; }
        #main-container { display: flex; flex-wrap: wrap; gap: 1.5em; margin-top: 1.5em; }
        #chat-wrapper { flex: 1; min-width: 350px; }
        #chat-log { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 1em; background: #f9f9f9; white-space: pre-wrap; }
        .chat-message { margin-bottom: 1em; }
        .chat-message.user { font-weight: bold; color: #0056b3; }
        .chat-message.ai { }
        #chat-form { display: none; margin-top: 1em; }
        #chat-form input { width: 70%; padding: 0.5em; }
        #chat-form button { width: 25%; padding: 0.5em; }
        #image-wrapper { flex: 1; min-width: 300px; }
        #image-wrapper h3 { margin-top: 0; }
        #imagen-generated-img { display: none; }
    </style>
</head>
<body>
    <h1>ğŸ“¸ AI í‘¸ë“œ ë Œì¦ˆ (Gemini + Imagen + Chat)</h1>
    <p>ë¶„ì„í•˜ê³  ì‹¶ì€ ìŒì‹ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ë©´, AIì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    
    <form id="upload-form">
        <input type="file" id="file-input" accept="image/*" required>
        <button type="submit">1. ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
    </form>
    
    <p id="loading">AIê°€ ì—´ì‹¬íˆ ë¶„ì„í•˜ê³ , ê·¸ë¦¼ë„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤... ğŸ¨</p>
    
    <div id="main-container">
        <div id="chat-wrapper">
            <h3>Gemini ëŒ€í™”ì°½:</h3>
            <div id="chat-log"><p>ì•„ì§ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="í›„ì† ì§ˆë¬¸í•˜ê¸° (ì˜ˆ: ì¹¼ë¡œë¦¬ ë‚®ì¶”ë ¤ë©´?)" required>
                <button type="submit">2. ì§ˆë¬¸ ì „ì†¡</button>
            </form>
        </div>
        <div id="image-wrapper">
            <h3>Imagen ì¶”ì²œ ì´ë¯¸ì§€:</h3>
            <img id="imagen-generated-img" src="" alt="AIê°€ ìƒì„±í•œ ì¶”ì²œ ì‹ë‹¨ ì´ë¯¸ì§€" />
            <p id="imagen-text">ì•„ì§ ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <h3>(ì›ë³¸ ì—…ë¡œë“œ ì´ë¯¸ì§€)</h3>
            <img id="preview" src="" alt="ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" style="display: none;" />
        </div>
    </div>

    <script>
        // --- â¬‡ï¸ JS ë¡œì§ ìˆ˜ì • â¬‡ï¸ ---
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const loadingEl = document.getElementById('loading');
        
        const chatLogEl = document.getElementById('chat-log');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        
        const imagenImgEl = document.getElementById('imagen-generated-img');
        const imagenTextEl = document.getElementById('imagen-text');
        const previewEl = document.getElementById('preview');

        const ANALYZE_URL = 'http://127.0.0.1:5000/analyze'; 
        const CHAT_URL = 'http://127.0.0.1:5000/chat';

        let chatHistory = []; // â­ï¸ (ìˆ˜ì •) [{'role': 'user'|'ai', 'message': '...'}]
        let originalImageBase64 = null; // â­ï¸ (ì‹ ê·œ) ì›ë³¸ ì´ë¯¸ì§€ Base64 ì €ì¥ ë³€ìˆ˜

        // (ê³µí†µ í•¨ìˆ˜) ì±„íŒ… ë¡œê·¸ì— ë©”ì‹œì§€ ì¶”ê°€
        function appendToChatLog(message, sender = 'ai') {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', sender);
            
            // â­ï¸ (ìˆ˜ì •) í”„ë¡ íŠ¸ì—ì„œ ë¡¤(Role) êµ¬ë¶„ í…ìŠ¤íŠ¸ ì¶”ê°€
            const senderTag = (sender === 'user') ? 'You:' : 'Food Lens:';
            messageEl.innerHTML = `<strong>${senderTag}</strong><br>${message.replace(/\n/g, '<br>')}`;
            
            chatLogEl.appendChild(messageEl);
            chatLogEl.scrollTop = chatLogEl.scrollHeight;
        }

        // (ê³µí†µ í•¨ìˆ˜) Imagen ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ (ì´ì „ê³¼ ë™ì¼)
        function updateImagen(imageUrl) {
            if (imageUrl) {
                imagenImgEl.src = imageUrl;
                imagenImgEl.style.display = 'block';
                imagenTextEl.style.display = 'none';
            } else {
                imagenImgEl.style.display = 'none';
                imagenTextEl.innerHTML = "ì¶”ì²œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                imagenTextEl.style.display = 'block';
            }
        }
        
        // â­ï¸ (ì‹ ê·œ) íŒŒì¼ ë¦¬ë”ë¥¼ ì´ìš©í•´ ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // "data:image/jpeg;base64," ë¶€ë¶„ì„ ì œê±°í•˜ê³  ìˆœìˆ˜ Base64 ë°ì´í„°ë§Œ ë°˜í™˜
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }

        // 1. (ì œì¶œ ì´ë²¤íŠ¸ 1) ì´ë¯¸ì§€ ì—…ë¡œë“œ
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const file = fileInput.files[0];
            if (!file) { alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            
            previewEl.src = URL.createObjectURL(file);
            previewEl.style.display = 'block';
            loadingEl.style.display = 'block';
            chatLogEl.innerHTML = "<p>ë¶„ì„ ì¤‘...</p>";
            imagenTextEl.innerHTML = "ìƒì„± ì¤‘...";
            imagenImgEl.style.display = 'none';
            chatHistory = []; // ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™”

            // â­ï¸ (ì‹ ê·œ) íŒŒì¼ Base64 ë³€í™˜
            try {
                originalImageBase64 = await fileToBase64(file);
            } catch (error) {
                chatLogEl.innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ì´ë¯¸ì§€ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ${error.message}</p>`;
                loadingEl.style.display = 'none';
                return;
            }

            const formData = new FormData();
            formData.append('image_file', file);

            try {
                const response = await fetch(ANALYZE_URL, {
                    method: 'POST',
                    body: formData, 
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                chatLogEl.innerHTML = ""; 
                appendToChatLog(data.analysis, 'ai'); // AI ì²« ì‘ë‹µ ì¶”ê°€
                chatHistory.push({ role: 'ai', message: data.analysis }); // â­ï¸ ê¸°ë¡ ì €ì¥
                
                updateImagen(data.new_image_url);
                chatForm.style.display = 'flex';

            } catch (error) {
                console.error("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                chatLogEl.innerHTML = `<p style="color: red;">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
            } finally {
                loadingEl.style.display = 'none';
            }
        });

        // 2. (ì œì¶œ ì´ë²¤íŠ¸ 2) í›„ì† ì§ˆë¬¸ ì „ì†¡
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;

            appendToChatLog(message, 'user'); // ì‚¬ìš©ì ë©”ì‹œì§€ ë¨¼ì € ì¶”ê°€
            chatHistory.push({ role: 'user', message: message }); // â­ï¸ ê¸°ë¡ ì €ì¥
            chatInput.value = ""; 
            loadingEl.style.display = 'block';
            
            // â­ï¸ (ìˆ˜ì •) ì´ì „ ëŒ€í™” ê¸°ë¡ì„ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ í•©ì¹˜ê¸°
            const history_text = chatHistory
                .map(entry => `${entry.role}: ${entry.message}`)
                .join('\n\n');

            try {
                const response = await fetch(CHAT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history_text: history_text, // â­ï¸ í•©ì¹œ í…ìŠ¤íŠ¸ ì „ì†¡
                        image_base64: originalImageBase64 // â­ï¸ ì›ë³¸ ì´ë¯¸ì§€ ì „ì†¡
                    }), 
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);

                appendToChatLog(data.analysis, 'ai'); // AI í›„ì† ì‘ë‹µ ì¶”ê°€
                chatHistory.push({ role: 'ai', message: data.analysis }); // â­ï¸ ê¸°ë¡ ì €ì¥
                
                updateImagen(data.new_image_url);

            } catch (error) {
                console.error("ì±„íŒ… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                appendToChatLog(`<p style="color: red;">ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`, 'ai');
            } finally {
                loadingEl.style.display = 'none';
            }
        });
        // --- â¬†ï¸ JS ë¡œì§ ìˆ˜ì • â¬†ï¸ ---
    </script>
</body>
</html>